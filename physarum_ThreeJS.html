<!DOCTYPE HTML>
<html>
    <head>
        <title>Physarum</title>
        <link rel="icon" href="/build/icon.jpg">

        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100%; }
        </style>
    </head>

    <body>
        <script src="build/stats.min.js"></script>
        <script src="build/dat.gui.min.js"></script>


        <script type="module">
            import * as THREE from "./build/three.module.js";

            import { OrbitControls } from "./build/OrbitControls.js";
            import { GLTFLoader } from "./build/GLTFLoader.js";
            import { RGBELoader } from "./build/RGBELoader.js";
            import { RoughnessMipmapper } from "./build/RoughnessMipmapper.js";


            const FizzyText = function () {
                this.particles = "0";
                this.color = [255, 255, 0]; // RGB array
                this.point_width = 1;

                this.time = 0;

                this.draw_cube = true;
                this.play = true;
                this.turn_on = false;
                this.current_save = start_save;

                this.reset_defaults = function () {
                    /* Here is the update */
                    for (var i = 0; i < window.gui.__controllers.length; i++) {
                        window.gui.__controllers[i].setValue(gui.__controllers[i].initialValue);
                    }
                };

                this.restart = function () {
                    FrameId = 2;
                    window.text.play = true;
                    window.arrayOfPoints = [];

                    // clear window.scene from points
                    while (window.scene.children.length > 2) {
                        var selectedObject = window.scene.getObjectByName("point");
                        window.scene.remove(selectedObject);
                    }
                    // var trigger = httpGet("/refresh");
                    // window.data = fileGet("build/saves/" + window.text.current_save + ".json");
                };
            };


            window.onload = function() {
                window.text = new FizzyText();
                window.gui = new dat.GUI({
                    load: JSON,
                    preset: "Flow"
                });
                window.gui.remember(window.text);
                window.gui.add(window.text, "particles").name("Particles").listen();

                var cl = window.gui.addColor(window.text, "color").name("Color");

                // var texture = window.gui.add(window.text, "draw_cube").name("Draw cube");
                var size = window.gui.add(window.text, "point_width", 0, 2).name("Point width");
                window.gui.add(window.text, "reset_defaults").name("Reset defaults");

                var playback = window.gui.addFolder("Playback");
                var pcontrol = playback.add(window.text, "play").name("Play").listen();
                playback.add(window.text, "restart").name("Restart");

                var chooser = playback.add(window.text, "current_save", all_saves).name("Choose save");

                playback.open();


                // pcontrol.onChange(function(value) {
                //     var trigger = httpGet("/refresh");
                //     window.data = fileGet("build/saves/" + window.text.current_save + ".json");
                // });

                chooser.onChange(function(value) {
                    FrameId = 2;
                    window.text.play = true;
                    while (window.scene.children.length > 2) {
                        var selectedObject = window.scene.getObjectByName("point");
                        window.scene.remove(selectedObject);
                    }
                    window.arrayOfPoints = [];
                    window.data = fileGet("build/saves/" + window.text.current_save + ".json");
                });

                size.onChange(function(value){
                    refresh_points();
                });

                cl.onChange(function(value){
                    window.text.color[0] = value[0];
                    window.text.color[1] = value[1];
                    window.text.color[2] = value[2];
                    refresh_points();
                });
            };


            /**
             * Sends a request to the url and returns parsed response
             * 
             * @param The url of a server for request
             * @returns Server response as parsed json object
             */
            function httpGet(theUrl) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open("GET", theUrl, false); // false for synchronous request
                xmlHttp.send(null);
                return JSON.parse(xmlHttp.responseText);
            }

            function fileGet(file_name) {
                var rawFile = new XMLHttpRequest();
                var allText = "";
                rawFile.open("GET", file_name, false);
                rawFile.onreadystatechange = function () {
                    if(rawFile.readyState === 4) {
                        if(rawFile.status === 200 || rawFile.status === 0) {
                            allText = rawFile.responseText;
                        }
                    }
                };
                rawFile.send(null);
                return JSON.parse(allText);
            }

            function refresh_points() {
                var frame = window.data[FrameId];
                for (var i = 0; i < frame["x"].length; ++i) {
                    window.arrayOfPoints[i].material.color.r = window.text.color[0] / 255;
                    window.arrayOfPoints[i].material.color.g = window.text.color[1] / 255;
                    window.arrayOfPoints[i].material.color.b = window.text.color[2] / 255;

                    window.arrayOfPoints[i].scale.x = window.text.point_width;
                    window.arrayOfPoints[i].scale.y = window.text.point_width;
                    window.arrayOfPoints[i].scale.z = window.text.point_width;
                }
            }

            function renderPoints(frame) {
                /*
                Given points coordinates (frame) window.scene, and RGB color, adds all particles to a window.scene
                */

                for (var i = 0; i < frame["x"].length; ++i) {
                    if (i < window.arrayOfPoints.length) {
                        window.arrayOfPoints[i].position.x = frame["x"][i];
                        window.arrayOfPoints[i].position.y = frame["y"][i];
                        window.arrayOfPoints[i].position.z = frame["z"][i];
                    } else {
                        var color = new THREE.Color("rgb(" + Math.round(window.text.color[0]) + "," + Math.round(window.text.color[1]) + "," + Math.round(window.text.color[2]) + ")");
                        var geometry = new THREE.SphereGeometry(window.default_size * window.text.point_width, 10, 10);
                        var material = new THREE.MeshBasicMaterial({color: color, wireframe: false});

                        var point = new THREE.Mesh(geometry, material);
                        point.name = "point";
                        window.scene.add(point);
                        window.arrayOfPoints.push(point);
                        
                        window.arrayOfPoints[i].position.x = frame["x"][i];
                        window.arrayOfPoints[i].position.y = frame["y"][i];
                        window.arrayOfPoints[i].position.z = frame["z"][i];
                    }
                }
            }


            function add_textures(matrix_style) {
                // create the shape
                var geometry = new THREE.BoxGeometry(1, 1, 1);
                if (!matrix_style) {
                    // create a material, color or image texture
                    var material = new THREE.MeshFaceMaterial(cubeMaterials);
                    var cube = new THREE.Mesh(geometry, material);
                    window.scene.add(cube);
                }

                // light
                var ambientLight = new THREE.AmbientLight(0xFFFFFF, 1);
                window.scene.add(ambientLight);
            }


            window.arrayOfPoints = [];
            var IS_MATRIX = false;
            window.default_size = 0.01;
            var path = "build/textures/concrete_texture.jpg";
            var cubeMaterials = [
                new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // RIGHT SIDE
                new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // LEFT SIDE
                new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // TOP SIDE
                new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // BOTTOM SIDE
                new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // FRONT SIDE
                new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide})  // BACK SIDE
            ];

            function restart() {
                window.scene = new THREE.Scene();
                window.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                window.stats = initStats();

                window.renderer = new THREE.WebGLRenderer();
                window.renderer.setSize(window.innerWidth, window.innerHeight);

                document.body.appendChild(window.renderer.domElement);
                var controls = new OrbitControls(window.camera, window.renderer.domElement);
                var pmremGenerator = new THREE.PMREMGenerator(window.renderer);

                pmremGenerator.compileEquirectangularShader();

                window.addEventListener("resize", function () {
                    var width = window.innerWidth;
                    var height = window.innerHeight;
                    window.renderer.setSize(width, height);
                    window.camera.aspect = width / height;
                    window.camera.updateProjectionMatrix();
                });


                // 3D models loader
                new RGBELoader()
                    .setDataType(THREE.UnsignedByteType)
                    .setPath("build/models/")
                    .load("royal_esplanade_1k.hdr", function (texture) {

                        var envMap = pmremGenerator.fromEquirectangular(texture).texture;

                        window.scene.background = envMap;
                        window.scene.environment = envMap;

                        texture.dispose();
                        pmremGenerator.dispose();

                        render();
                        var roughnessMipmapper = new RoughnessMipmapper(window.renderer);
                        var loader = new GLTFLoader().setPath("build/models/");

                        loader.load("cobra.gltf", function (gltf) {
                            gltf.scene.traverse(function (child) {
                                if (child.isMesh) {
                                    roughnessMipmapper.generateMipmaps(child.material);
                                }
                            });

                            // add 3D model to set
                            // window.scene.add(gltf.scene);
                            roughnessMipmapper.dispose();
                            render();
                        });
                    });
                add_textures(IS_MATRIX);
                window.camera.position.z = -3;
                window.camera.rotation.y = 3.14;
            }
            restart();

            var FrameId = 1;
            var start_save = fileGet("/build/saves/names.json")["default_name"];
            var all_saves = fileGet("/build/saves/names.json")["names"];
            window.text = new FizzyText();

            // game logic
            var update = function() {
                // window.camera.position.z = window.camera.position.z + 0.1;
            };

            // draw scene
            var render = function() {
                window.renderer.render(window.scene, window.camera);    
            };

            // run game loop (update, render, repeat)
            window.data = fileGet("/build/saves/" + window.text.current_save + ".json");
            var GameLoop = function() {
                requestAnimationFrame(GameLoop);
                window.stats.begin();   

                var trigger = {"status": true};
                // var trigger = httpGet("/get_status");
                // var window.data = httpGet("/get_frame");

                if (window.text.play && FrameId < window.data.length - 1 && FrameId !== 0) {
                    FrameId++;
                }

                if (trigger["status"] && window.data.length - 1 !== FrameId) {
                    window.text.particles = window.data[FrameId]["x"].length;
                    renderPoints(window.data[FrameId], window.scene, IS_MATRIX);
                }

                update();
                render();
                window.stats.end();
            };


            GameLoop(window.scene);
            function initStats() {
                window.stats = new Stats();
                window.stats.setMode(0); // 0: fps, 1: ms

                // Align top-left
                window.stats.domElement.style.position = "absolute";
                window.stats.domElement.style.left = "0px";
                window.stats.domElement.style.top = "0px";
                document.body.appendChild( stats.dom );
                return stats;
            }
        </script>
    </body>
</html>